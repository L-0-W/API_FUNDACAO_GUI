<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Admin - Ações</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
                margin: 0;
                background-color: #f5f5f5;
            }

            .container {
                background: white;
                padding: 2rem;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                width: 320px;
            }

            .container h2 {
                margin-bottom: 1.5rem;
                text-align: center;
            }

            .input-group {
                margin-bottom: 1rem;
            }

            .input-group label {
                display: block;
                margin-bottom: 0.5rem;
                font-weight: bold;
            }

            .input-group input,
            .input-group select {
                width: 100%;
                padding: 0.5rem;
                box-sizing: border-box;
                border: 1px solid #ccc;
                border-radius: 4px;
            }

            button {
                width: 100%;
                padding: 0.75rem;
                background-color: #007bff;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 1rem;
            }

            button:hover {
                background-color: #0056b3;
            }

            .hidden {
                display: none;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <!-- Formulário de Login -->
            <form id="loginForm">
                <h2>Login Admin</h2>
                <div class="input-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required />
                </div>
                <div class="input-group">
                    <label for="senha">Senha</label>
                    <input type="password" id="senha" required />
                </div>
                <button type="submit">Entrar</button>
            </form>

            <!-- Formulário de Ação (inicialmente escondido) -->
            <form id="acaoForm" class="hidden">
                <h2>Escolha a Ação</h2>
                <div class="input-group">
                    <label for="tipo">Tipo</label>
                    <select id="tipo" required>
                        <option value="exame">Exame</option>
                        <option value="setor">Setor</option>
                        <option value="bloco">Bloco</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="id">ID</label>
                    <input type="number" id="id" min="1" required />
                </div>
                <button type="submit">Excluir</button>
            </form>
        </div>

        <script>
            const loginForm = document.getElementById("loginForm");
            const acaoForm = document.getElementById("acaoForm");

            // Função para extrair o token da mensagem
            function extrairToken(mensagem) {
                const match = mensagem.match(/Token Gerado: (.+)/);
                return match ? match[1] : null;
            }

            // Login
            loginForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                const email = document.getElementById("email").value;
                const senha = document.getElementById("senha").value;

                try {
                    const res = await fetch(
                        "http://localhost:3003/loginAdmin",
                        {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ email, senha }),
                        },
                    );

                    const data = await res.json();
                    console.log("Resposta do login:", data);

                    if (data.codigoStatus === 200) {
                        const token = extrairToken(data.mensagem);
                        if (token) {
                            localStorage.setItem("adminToken", token);
                            // Troca de tela
                            loginForm.classList.add("hidden");
                            acaoForm.classList.remove("hidden");
                        } else {
                            alert("Erro: Token não encontrado na resposta.");
                        }
                    } else {
                        alert(
                            "Login falhou: " +
                                (data.mensagem || "Erro desconhecido"),
                        );
                    }
                } catch (err) {
                    console.error("Erro na requisição de login:", err);
                    alert("Erro ao conectar com a API.");
                }
            });

            // Ação de exclusão
            acaoForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                const tipo = document.getElementById("tipo").value;
                const id = document.getElementById("id").value;

                if (!id || id <= 0) {
                    alert("Por favor, insira um ID válido.");
                    return;
                }

                const token = localStorage.getItem("adminToken");
                if (!token) {
                    alert("Token não encontrado. Faça login novamente.");
                    return;
                }

                const url = `http://localhost:3003/adminAcao/${tipo}/${id}`;

                try {
                    const res = await fetch(url, {
                        method: "DELETE",
                        headers: {
                            Authorization: `Bearer ${token}`,
                        },
                    });

                    const result = await res.json();
                    console.log("Resposta da exclusão:", result);

                    if (res.ok) {
                        alert("Exclusão realizada com sucesso!");
                    } else {
                        alert(
                            "Erro na exclusão: " +
                                (result.mensagem || "Erro desconhecido"),
                        );
                    }
                } catch (err) {
                    console.error("Erro na requisição de exclusão:", err);
                    alert("Erro ao conectar com a API.");
                }
            });
        </script>
    </body>
</html>
